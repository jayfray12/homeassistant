blueprint:
  name: Holiday Lighting Schedule (Sunset & Optional Lights)
  description: Change light colors between two dates at sunset and reset afterward. Works with 1â€“3 lights.
  domain: automation
  input:
    light_1:
      name: Light 1 (e.g. Red)
      default: ''
      selector:
        entity:
          domain: light
          multiple: false
    light_1_color:
      name: Light 1 RGB Color
      default: [255, 0, 0]
      selector:
        color_rgb: {}

    light_2:
      name: Light 2 (e.g. White)
      default: ''
      selector:
        entity:
          domain: light
          multiple: false
    light_2_color:
      name: Light 2 RGB Color
      default: [255, 255, 255]
      selector:
        color_rgb: {}

    light_3:
      name: Light 3 (e.g. Blue)
      default: ''
      selector:
        entity:
          domain: light
          multiple: false
    light_3_color:
      name: Light 3 RGB Color
      default: [0, 0, 255]
      selector:
        color_rgb: {}

    start_month_day:
      name: Start Month/Day (MM-DD)
      description: 'The month and day to start the holiday lights each year (e.g., 11-30 for Nov 30).'
      selector:
        text: {} # Changed from date to text, as date selector always includes year

    end_month_day:
      name: End Month/Day (MM-DD)
      description: 'The month and day to end the holiday lights each year (e.g., 01-03 for Jan 3).'
      selector:
        text: {} # Changed from date to text, as date selector always includes year

    reset_color_temp:
      name: Reset Color Temperature (mireds)
      default: 370
      selector:
        number:
          min: 150
          max: 500
          unit_of_measurement: mireds

    sunset_offset:
      name: Sunset Offset (HH:MM:SS)
      description: 'Offset from sunset for the primary trigger. E.g., +00:15:00 for 15 mins after sunset.'
      default: '+00:00:00'
      selector:
        text: {}

    enable_light_on_trigger:
      name: Enable Light On Trigger
      description: 'If enabled, the automation will also trigger when any of the selected lights turn on, to ensure colors are applied.'
      default: true
      selector:
        boolean: {}

    brightness_pct:
      name: Holiday Brightness (%)
      description: 'Brightness percentage for holiday colors (1-100).'
      default: 100
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: '%'
          mode: slider

    reset_brightness_pct:
      name: Reset Brightness (%)
      description: 'Brightness percentage for reset color (1-100).'
      default: 50
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: '%'
          mode: slider

trigger:
  - platform: sun
    event: sunset
    offset: !input sunset_offset

  - platform: state
    entity_id: >
      {% set entities = [] %}
      {% if inputs.light_1 != '' %}
        {% set entities = entities + [inputs.light_1] %}
      {% endif %}
      {% if inputs.light_2 != '' %}
        {% set entities = entities + [inputs.light_2] %}
      {% endif %}
      {% if inputs.light_3 != '' %}
        {% set entities = entities + [inputs.light_3] %}
      {% endif %}
      {{ entities }}
    from: "off"
    to: "on"
    enabled: "{{ inputs.enable_light_on_trigger }}"

condition:
  # Get current month/day
  - variables:
      current_month_day: "{{ now().strftime('%m-%d') }}"
      # Extract month/day from inputs (e.g., '11-30')
      start_md: "{{ inputs.start_month_day }}"
      end_md: "{{ inputs.end_month_day }}"
  - condition: or
    conditions:
      # Condition for within the holiday period (e.g., Nov 30 - Jan 3)
      - condition: template
        value_template: >
          {% set start_month = start_md.split('-')[0] | int %}
          {% set start_day = start_md.split('-')[1] | int %}
          {% set end_month = end_md.split('-')[0] | int %}
          {% set end_day = end_md.split('-')[1] | int %}

          {% set current_month = now().month %}
          {% set current_day = now().day %}

          {# Handle cases where the period spans across year end (e.g., Dec 15 to Jan 5) #}
          {% if start_month > end_month %}
            {# Period spans year end, e.g., Nov to Jan #}
            {{ (current_month > start_month or (current_month == start_month and current_day >= start_day)) or
               (current_month < end_month or (current_month == end_month and current_day <= end_day)) }}
          {% elif start_month == end_month %}
            {# Period within the same month #}
            {{ current_month == start_month and current_day >= start_day and current_day <= end_day }}
          {% else %}
            {# Period within the same year, normal range #}
            {{ (current_month > start_month or (current_month == start_month and current_day >= start_day)) and
               (current_month < end_month or (current_month == end_month and current_day <= end_day)) }}
          {% endif %}

      # Condition for the day AFTER the end date (for resetting lights)
      - condition: template
        value_template: >
          {% set end_month = inputs.end_month_day.split('-')[0] | int %}
          {% set end_day = inputs.end_month_day.split('-')[1] | int %}

          {% set next_day = (now() + timedelta(days=1)) %}
          {% set next_day_month = next_day.month %}
          {% set next_day_day = next_day.day %}

          {{ next_day_month == end_month and next_day_day == end_day }}

action:
  - choose:
      # Condition for within the holiday period
      - conditions:
          - variables:
              start_md: "{{ inputs.start_month_day }}"
              end_md: "{{ inputs.end_month_day }}"
          - condition: template
            value_template: >
              {% set start_month = start_md.split('-')[0] | int %}
              {% set start_day = start_md.split('-')[1] | int %}
              {% set end_month = end_md.split('-')[0] | int %}
              {% set end_day = end_md.split('-')[1] | int %}

              {% set current_month = now().month %}
              {% set current_day = now().day %}

              {% if start_month > end_month %}
                {{ (current_month > start_month or (current_month == start_month and current_day >= start_day)) or
                   (current_month < end_month or (current_month == end_month and current_day <= end_day)) }}
              {% elif start_month == end_month %}
                {{ current_month == start_month and current_day >= start_day and current_day <= end_day }}
              {% else %}
                {{ (current_month > start_month or (current_month == start_month and current_day >= start_day)) and
                   (current_month < end_month or (current_month == end_month and current_day <= end_day)) }}
              {% endif %}
        sequence:
          - variables:
              target_entities: >
                {% set entities = [] %}
                {% if inputs.light_1 != '' %}
                  {% set entities = entities + [inputs.light_1] %}
                {% endif %}
                {% if inputs.light_2 != '' %}
                  {% set entities = entities + [inputs.light_2] %}
                {% endif %}
                {% if inputs.light_3 != '' %}
                  {% set entities = entities + [inputs.light_3] %}
                {% endif %}
                {{ entities }}
            if: "{{ target_entities | length > 0 }}"
            then:
              - service: light.turn_on
                target:
                  entity_id: "{{ target_entities }}"
                data:
                  rgb_color: >
                    {% if loop.index == 1 %} !input light_1_color
                    {% elif loop.index == 2 %} !input light_2_color
                    {% elif loop.index == 3 %} !input light_3_color
                    {% endif %}
                  brightness_pct: !input brightness_pct

      # Condition for the day AFTER the end date (for resetting lights)
      - conditions:
          - variables:
              end_md: "{{ inputs.end_month_day }}"
          - condition: template
            value_template: >
              {% set end_month = end_md.split('-')[0] | int %}
              {% set end_day = end_md.split('-')[1] | int %}

              {% set next_day = (now() + timedelta(days=1)) %}
              {% set next_day_month = next_day.month %}
              {% set next_day_day = next_day.day %}

              {{ next_day_month == end_month and next_day_day == end_day }}
        sequence:
          - variables:
              target_entities_reset: >
                {% set entities = [] %}
                {% if inputs.light_1 != '' %}
                  {% set entities = entities + [inputs.light_1] %}
                {% endif %}
                {% if inputs.light_2 != '' %}
                  {% set entities = entities + [inputs.light_2] %}
                {% endif %}
                {% if inputs.light_3 != '' %}
                  {% set entities = entities + [inputs.light_3] %}
                {% endif %}
                {{ entities }}
            if: "{{ target_entities_reset | length > 0 }}"
            then:
              - service: light.turn_on
                target:
                  entity_id: "{{ target_entities_reset }}"
                data:
                  color_temp: !input reset_color_temp
                  brightness_pct: !input reset_brightness_pct
mode: single
